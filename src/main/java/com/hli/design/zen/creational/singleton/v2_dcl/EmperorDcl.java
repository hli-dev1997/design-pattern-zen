package com.hli.design.zen.creational.singleton.v2_dcl;

import lombok.extern.slf4j.Slf4j;

/**
 * çš‡å¸ç±»ï¼ˆåŒé‡æ£€æŸ¥é”ç‰ˆï¼‰
 *
 * è®¾è®¡ç›®çš„ï¼š
 * 1. æ¼”ç¤ºåŒé‡æ£€æŸ¥é”ï¼ˆDCLï¼‰å•ä¾‹æ¨¡å¼çš„æ­£ç¡®å®ç°ã€‚
 * 2. è§£å†³æ‡’æ±‰å¼å•ä¾‹åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
 * 3. ä¿è¯é«˜æ€§èƒ½çš„åŒæ—¶ç¡®ä¿å•ä¾‹å”¯ä¸€æ€§ã€‚
 *
 * ä¸ºä»€ä¹ˆéœ€è¦è¯¥ç±»ï¼š
 * ä½œä¸ºé¢è¯•æ ‡å‡†ç­”æ¡ˆï¼Œå±•ç¤ºå¦‚ä½•åœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‰æä¸‹ï¼Œå°½å¯èƒ½å‡å°‘é”çš„å¼€é”€ã€‚
 *
 * æ ¸å¿ƒå®ç°æ€è·¯ï¼š
 * - ä½¿ç”¨ volatile å…³é”®å­—ä¿®é¥° instanceï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’ã€‚
 * - ç¬¬ä¸€å±‚æ£€æŸ¥ï¼šå¦‚æœ instance ä¸ä¸º nullï¼Œç›´æ¥è¿”å›ï¼Œé¿å…ä¸å¿…è¦çš„åŒæ­¥ã€‚
 * - synchronized é”ï¼šä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥åˆ›å»ºå®ä¾‹çš„ä»£ç å—ã€‚
 * - ç¬¬äºŒå±‚æ£€æŸ¥ï¼šé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡ç¬¬ä¸€å±‚æ£€æŸ¥åï¼Œé‡å¤åˆ›å»ºå®ä¾‹ã€‚
 */
@Slf4j
public class EmperorDcl {
    
    // ä½¿ç”¨ volatile ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å¯è§æ€§ä¸æœ‰åºæ€§
    private static volatile EmperorDcl instance; 
    
    private EmperorDcl() {
        // ğŸ“ å…³é”®æ—¥å¿—ï¼šåº”è¯¥åªæ‰“å°ä¸€æ¬¡
        log.info("çš‡å¸(DCLç‰ˆ)ç™»åŸºäº†ï¼|Emperor_DCL_created,hash={},thread={}", 
                System.identityHashCode(this), Thread.currentThread().getName());
    }

    /**
     * è·å–çš‡å¸å®ä¾‹
     *
     * å®ç°é€»è¾‘ï¼š
     * 1. ç¬¬ä¸€å±‚æ£€æŸ¥ï¼šè‹¥ instance å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œæ— éœ€åŠ é”ï¼Œæå‡æ€§èƒ½ã€‚
     * 2. åŠ é”ï¼šè‹¥ instance ä¸å­˜åœ¨ï¼Œè¿›å…¥åŒæ­¥å—ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚
     * 3. ç¬¬äºŒå±‚æ£€æŸ¥ï¼šå†æ¬¡æ£€æŸ¥ instance æ˜¯å¦å­˜åœ¨ï¼Œé˜²æ­¢å¹¶å‘åœºæ™¯ä¸‹é‡å¤åˆ›å»ºã€‚
     * 4. åˆ›å»ºå®ä¾‹ï¼šè‹¥ä»ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºæ–°å®ä¾‹ã€‚
     *
     * @return çš‡å¸å®ä¾‹
     */
    public static EmperorDcl getInstance() {
        // ç¬¬ä¸€å±‚æ£€æŸ¥ï¼šä¸ºäº†æ€§èƒ½ï¼Œä¸è®©å¤§å®¶éƒ½åœ¨å¤–é¢æ’é˜Ÿ
        if (instance == null) { 
            // åªæœ‰æŠ¢åˆ°é”çš„æ‰èƒ½è¿›å»
            synchronized (EmperorDcl.class) { 
                // ç¬¬äºŒå±‚æ£€æŸ¥ï¼šé˜²æ­¢æœ‰äººè¶è™šè€Œå…¥
                if (instance == null) { 
                    log.info("çº¿ç¨‹æŠ¢åˆ°äº†é”|Thread_acquired_lock,thread={}", Thread.currentThread().getName());
                    instance = new EmperorDcl();
                } else {
                    log.info("çº¿ç¨‹è¢«æŒ¡åœ¨é—¨å¤–|Thread_blocked_by_double_check,thread={}", Thread.currentThread().getName());
                }
            }
        }
        return instance;
    }
}
