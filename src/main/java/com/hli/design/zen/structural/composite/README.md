# 组合模式 (Composite Pattern)

> 📖 对应《设计模式之禅》第21章：组合模式

---

## 一、概述

**组合模式**（Composite Pattern）将对象组合成树形结构以表示"部分-整体"的层次结构，使客户端对单个对象和组合对象的使用具有一致性。

> **核心思想**：统一叶子节点和树枝节点的操作接口，让客户端无差别地处理单个对象和组合对象

---

## 二、角色定义

| 角色 | 说明 |
|------|------|
| Component（抽象组件） | 定义组合中所有对象的通用接口，可声明管理子节点的方法 |
| Leaf（叶子节点） | 组合中的叶节点对象，没有子节点 |
| Composite（树枝节点） | 存储子组件，实现与子组件相关的操作 |
| Client（客户端） | 通过 Component 接口操作组合结构中的对象 |

---

## 三、两种实现方式

| 类型 | 实现方式 | 优点 | 缺点 |
|------|----------|------|------|
| 透明方式 | Component 声明所有方法 | 客户端无需区分 Leaf 和 Composite | Leaf 需实现无意义的管理方法 |
| 安全方式 | Composite 中声明管理方法 | 职责清晰，无空实现 | 客户端需区分 Leaf 和 Composite |

> **推荐**：根据业务场景选择，通用性优先选透明方式，安全性优先选安全方式

---

## 四、版本演进

- `common` - 公共组件：抽象组件接口
- `v1_transparent` - 透明方式：在抽象组件中声明所有操作
- `v2_safe` - 安全方式：在树枝节点中声明管理子节点的操作

---

## 五、类图

### 5.1 透明模式

```
        ┌─────────────────────┐
        │     Component       │
        │    (interface)      │
        ├─────────────────────┤
        │ +operation()        │
        │ +add(Component)     │
        │ +remove(Component)  │
        │ +getChild(int)      │
        └─────────────────────┘
                  △
                  │ implements
         ┌────────┴────────┐
         │                 │
┌────────────────┐  ┌───────────────────┐
│      Leaf      │  │    Composite      │
├────────────────┤  ├───────────────────┤
│ +operation()   │  │ -children: List   │
│ +add() → 抛异常│  │ +operation()      │
│ +remove()→ 空  │  │ +add(Component)   │
└────────────────┘  │ +remove(Component)│
                    │ +getChild(int)    │
                    └───────────────────┘
```

### 5.2 安全模式

```
        ┌─────────────────┐
        │    Component    │
        │   (interface)   │
        ├─────────────────┤
        │ +operation()    │
        └─────────────────┘
                △
                │ implements
       ┌────────┴────────┐
       │                 │
┌──────────────┐  ┌───────────────────┐
│     Leaf     │  │    Composite      │
├──────────────┤  ├───────────────────┤
│ +operation() │  │ -children: List   │
└──────────────┘  │ +operation()      │
                  │ +add(Component)   │
                  │ +remove(Component)│
                  │ +getChild(int)    │
                  └───────────────────┘
```

---

## 六、适用场景

1. **文件系统**：文件和文件夹的统一操作
2. **组织架构**：公司、部门、员工的层级结构
3. **GUI 组件**：容器与控件的统一处理
4. **菜单系统**：菜单项和子菜单的递归组织

---

## 七、JDK & Spring 应用

| 框架 | 类 | 说明 |
|------|-----|------|
| JDK | `java.awt.Container` | GUI 容器，可包含其他组件 |
| JDK | `java.io.File` | 文件和目录的统一抽象 |
| JDK | `javax.swing.JComponent` | Swing 组件树 |
| MyBatis | `SqlNode` | SQL 语句的树形拼接 |
| Spring Security | `FilterChainProxy` | 过滤器链的组合 |

---

## 八、与其他模式对比

| 模式 | 目的 | 结构特点 |
|------|------|----------|
| 组合模式 | 表示层次结构 | 树形结构，统一操作 |
| 装饰器模式 | 动态添加功能 | 链式结构，功能增强 |
| 迭代器模式 | 遍历集合 | 可与组合配合遍历树 |
| 访问者模式 | 分离操作与结构 | 可与组合配合添加操作 |

---

## 九、面试常见问题

### Q1：什么时候使用组合模式？

> **答**：当需要表示对象的"部分-整体"层次结构，且希望客户端能统一处理单个对象和组合对象时。

### Q2：透明模式和安全模式如何选择？

> **答**：
> - **透明模式**：客户端完全透明，但叶子节点需要处理不支持的操作
> - **安全模式**：类型安全，但客户端需要区分节点类型

### Q3：组合模式和装饰器模式的区别？

> **答**：
> - **组合模式**：强调"部分-整体"的树形结构
> - **装饰器模式**：强调动态添加职责，是一条链

---

> 📌 **学习建议**：组合模式在文件系统和 GUI 编程中非常常见，重点理解"统一操作接口"的核心思想。
